# 工作区迁移总结 — 转到新工作区用

> 用于从当前工作区（路径含中文）迁移到英文路径新工作区时，快速恢复上下文。

---

## 一、项目与结构

- **项目**：EVM (Base) 最小化 dApp 授权系统，Monorepo（pnpm workspace）。
- **当前工作区路径**：`d:\Dapp授权`（含中文，终端 cd 会因编码报错，建议改为英文如 `DappAuth` 后在新路径打开）。
- **结构**：
  - `apps/api` — Express 后端（4000）
  - `apps/admin` — 管理后台 Next.js（3001）
  - `apps/web` — 用户端 Next.js + wagmi（3000）
  - `packages/db` — Prisma schema + client
  - `packages/core` — 共享类型、SIWE
  - `contracts` — Solidity + Hardhat，**合约源码在 `contracts/src/`**

---

## 二、Step 2 已完成的改动（扣费服务化）

### 1. 新增文件

| 路径 | 说明 |
|------|------|
| `apps/api/src/services/settingsService.ts` | 从 Prisma Setting 表读配置：`getSetting(key)` / `getRequiredSetting(key)`，内存缓存 30s |
| `apps/api/src/services/chargeService.ts` | `ApiError` 类；`chargeUser({ address, amount, ref, adminUser })`：读 settings、校验、幂等(ref)、链上 allowance/balance、upsert Charge、发交易、写 Event |
| `contracts/src/Charger.sol` | 新合约：构造 (token, treasury, maxSingleCharge, owner)；owner 治理 setTreasury/setOperator/setMaxSingleCharge/pause/unpause；operator 白名单调 charge；nonReentrant + whenNotPaused |

### 2. 修改文件

| 路径 | 改动要点 |
|------|----------|
| `apps/api/src/routes/charge.ts` | POST /charge：requireAdmin，body 含 address/amount/ref（可选，缺则 crypto.randomUUID()），调 chargeService.chargeUser；错误按 ApiError 返回 statusCode/errorCode；GET /charge/status 返回 Charge 含新 status 枚举 |
| `apps/api/src/middleware/adminAuth.ts` | **ALLOW_BASIC_AUTH=true** 才允许 Basic Auth，默认 false；session 通过即放行；requireAdmin 在 req 上挂 adminUser（优先 session.adminUser，否则 ADMIN_USER） |
| `apps/web/next.config.js` | `outputFileTracingRoot` 移到 `experimental` 下；webpack fallback 增加 `pino-pretty`、`@react-native-async-storage/async-storage` 为 false，消除构建警告 |

### 3. 数据与验收

- **Charge**：ref 唯一、status 枚举 SUBMITTED/CONFIRMED/FAILED、chainId/tokenAddress/requestedBy 已存在；幂等：同一 ref 有 txHash 直接返回不重复发交易。
- **链上前置**：未 approve/余额不足时 409 VALIDATION_FAILED，不发交易。
- **Event**：扣费提交时写 status=SUBMITTED、metadata.action=CHARGE_SUBMITTED，与链上确认后的 SUCCESS 区分。

---

## 三、环境与配置

### 环境变量（.env / 部署）

- **必填**：`DATABASE_URL`、`CHARGER_PRIVATE_KEY`（扣费 signer）。
- **API**：`SESSION_SECRET`、`ADMIN_USER` / `ADMIN_PASSWORD`；**ALLOW_BASIC_AUTH=true** 才允许 Basic Auth（生产建议 false）。
- **可选兜底**：`BASE_RPC_URL`（空则用 DB 或 "https://mainnet.base.org"）。

### DB settings 表（通过 admin 或 API PUT /settings 写入）

- **必填**：`CHARGER_CONTRACT_ADDRESS`、`USDT_ADDRESS`、`MAX_SINGLE_CHARGE_AMOUNT`（最小单位字符串）。
- **可选**：`BASE_RPC_URL`、`CONFIRMATIONS_REQUIRED`（默认 "2"，Step 3 用）。

### 新合约 Charger.sol 部署后

- 需 owner 调用 `setOperator(backendSignerAddress, true)` 将后端扣费地址加入白名单，否则 charge 会 revert NotOperator（若沿用“私钥=owner”则也可 setOperator(owner, true)）。

---

## 四、已知问题与待办

| 项 | 说明 |
|----|------|
| **终端路径编码** | 工作区路径含中文时，PowerShell `cd` 会报“找不到路径”（编码被破坏）。**解决**：将项目文件夹改名为纯英文（如 DappAuth），在新路径用 Cursor 重新打开。 |
| **Network ERR_CONNECTION_RESET** | Admin 访问 /dashboard/charge 或 /dashboard/settings 时，浏览器请求 `localhost:3001/...?_rsc=...` 被重置。多为 **Admin Next 进程** 在渲染时崩溃或未启动；少数为 API(4000) 未起或 NEXT_PUBLIC_API_URL 配错。排查：看 Admin/API 进程日志；确认 API 已起且 Admin 的 NEXT_PUBLIC_API_URL 指向可访问的 API 地址。 |
| **contracts 编译** | 合约在 `contracts/src/Charger.sol`，hardhat 已配 `paths.sources: "./src"`。在**英文路径**下于 `contracts` 目录执行 `pnpm run compile` 验证编译。 |
| **Step 3** | 链上确认数（CONFIRMATIONS_REQUIRED）、Charge 状态从 SUBMITTED 更新为 CONFIRMED/FAILED 等，按需求后续实现。 |

---

## 五、更新到本地 Docker

在项目根目录执行（Windows 若 BuildKit 报错可先设 `$env:DOCKER_BUILDKIT=0`）：

```bash
# 重新构建镜像并启动（推荐：代码更新后执行）
pnpm run docker:up-build
# 或
docker compose up -d --build
```

仅启动（不重建）：`pnpm run docker:up` 或 `docker compose up -d`。  
仅构建：`pnpm run docker:build` 或 `docker compose build`。

若出现 `Bind for 0.0.0.0:5432 failed: port is already allocated`，说明本机 5432 已被占用（如本地 Postgres 或其他容器）。可先停止占用进程或执行 `docker compose down` 后重试。

---

## 六、新工作区建议第一步

1. 用**英文路径**重新打开项目（如 `d:\DappAuth`）。
2. 根目录执行：`pnpm install`。
3. 确认 `.env` 存在且含 `DATABASE_URL`、`CHARGER_PRIVATE_KEY` 等；DB 已建表（或执行 `pnpm --filter @dapp/db exec prisma migrate deploy`）。
4. 在 `contracts` 下执行 `pnpm run compile` 确认 Charger.sol 通过编译。
5. 需要时在 admin 后台或 DB 中写入 settings：CHARGER_CONTRACT_ADDRESS、USDT_ADDRESS、MAX_SINGLE_CHARGE_AMOUNT 等。

---

## 七、关键代码位置速查

- **扣费入口**：`apps/api/src/routes/charge.ts` — POST /、GET /status
- **扣费逻辑**：`apps/api/src/services/chargeService.ts` — chargeUser、ApiError
- **配置读取**：`apps/api/src/services/settingsService.ts` — getSetting、getRequiredSetting
- **Admin 鉴权**：`apps/api/src/middleware/adminAuth.ts` — adminAuth、requireAdmin，ALLOW_BASIC_AUTH
- **合约**：`contracts/src/Charger.sol` — owner/operator、charge、pause、setTreasury/setOperator/setMaxSingleCharge
- **Prisma**：`packages/db/prisma/schema.prisma` — Charge(ref/status/chainId/tokenAddress/requestedBy)、Event(actor/errorCode)、ChargeStatus 枚举

更多历史问题与修复见：`docs/开发任务汇报.md`。
