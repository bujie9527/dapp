# 部署密钥说明（待获取的密钥）

本文档列出将 Dapp 系统部署到生产环境（如 VPS 域名 dapp.sourcofsun.online）时，需要**由操作者提供或部署后填写**的所有密钥与关键配置；并说明每项的作用、获取方式与设置位置。部署时已自动生成的值（如用 `openssl rand -hex 32` 生成的 SESSION_SECRET）可标注为「已生成」并写明存放位置（如服务器上的 `.env`）。

---

## 一、密钥与配置列表

| 密钥/配置名 | 作用 | 获取方式 | 设置位置 | 是否必填 |
|------------|------|----------|----------|----------|
| **DATABASE_URL** | Prisma/API 连接 Postgres 的 connection string | 与 docker-compose 中 db 服务一致；格式：`postgresql://dapp:<密码>@db:5432/dapp`。若使用 [server-setup.sh](server-setup.sh)（同目录）默认 db 密码为 `dapp`；若自行修改 `POSTGRES_PASSWORD`，此处需同步 | 项目根目录 `.env`，由 docker-compose 传入 api 服务 | 部署必填 |
| **SESSION_SECRET** | API 的 session 签名密钥，用于 cookie 安全 | 随机长字符串。生成示例：`openssl rand -hex 32`。部署时可生成一次写入 `.env`，切勿使用默认值 | `.env`，api 服务 | 部署必填 |
| **CHARGER_PRIVATE_KEY** | 后端调用 Charger.charge 的 EOA 私钥（operator） | 用于 Charger 合约的 operator 钱包私钥（0x 开头）。需在部署合约后对该地址执行 `setOperator(operatorAddress, true)`。**绝不提交到仓库** | `.env`，api 服务 | 扣费功能必填 |
| **CHARGER_CONTRACT_ADDRESS** | Charger 合约地址 | 部署 [contracts/Charger.sol](../contracts/) 后从部署脚本输出或 Base 区块浏览器获取 | `.env`（api）+ Admin 后台「系统设置」 | 扣费功能必填 |
| **ADMIN_USER** | 管理后台登录账号 | 自设；与 ADMIN_PASSWORD 一起作为 Admin 登录凭据 | `.env`，api 服务（docker-compose 会传入） | 部署必填（建议改默认） |
| **ADMIN_PASSWORD** | 管理后台登录密码 | 自设强密码 | `.env`，api 服务 | 部署必填 |
| **COOKIE_SECURE** | Session cookie 是否仅通过 HTTPS 发送 | 生产环境填 `true` | `.env`，api 服务 | 生产推荐 true |
| **BASE_RPC_URL** | 后端发链上交易（扣费）使用的 Base 链 RPC | Base 主网：`https://mainnet.base.org`；或 Alchemy/Infura/QuickNode 等提供的 Base RPC URL；测试网用 `https://sepolia.base.org` | `.env`（api）和/或 Admin「系统设置」 | 可选，有默认 |
| **ALLOW_BASIC_AUTH** | 是否允许 HTTP Basic Auth 登录 Admin | 生产建议 `false`，仅用 session 登录 | `.env`，api 服务 | 可选，建议 false |
| **NEXT_PUBLIC_API_URL** | 前端（Web、Admin）请求 API 的根 URL | 生产示例：`https://api.sourcofsun.online`。须与 Nginx 反代后的 API 域名一致 | `.env`，docker-compose 构建/运行时传入 web、admin | 部署必填（生产域名） |
| **NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID** | WalletConnect 连接（Web 端扫码等） | 在 [WalletConnect Cloud](https://cloud.walletconnect.com) 创建项目，复制 Project ID；当前已配置在 .env.example | `.env`，web 服务（构建时通过 build args 注入） | 可选（用 WalletConnect 时必填） |
| **WalletConnect 身份验证令牌** | Cloud 控制台/API 管理用，非前端 | 在 Cloud 项目设置中获取；**勿写入前端或 .env 提交**，仅本地保管 | 不写入项目 | 仅管理时用 |
| **NEXT_PUBLIC_BASE_RPC_URL** | 前端连接 Base 链的 RPC | 同 BASE_RPC_URL，或与后端一致 | `.env`，web 服务 | 可选，有默认 |
| **NEXT_PUBLIC_USDT_ADDRESS** | 前端展示/调用的 USDT 合约地址 | 与 DB settings 中 USDT_ADDRESS 一致；Base 主网 USDT 地址可从官方文档或 basescan 查询 | `.env`，web 服务 | 前端链上操作前必填 |
| **NEXT_PUBLIC_CHARGER_CONTRACT_ADDRESS** | 前端使用的 Charger 合约地址 | 与 CHARGER_CONTRACT_ADDRESS 一致 | `.env`，web 服务 | 前端授权/扣费前必填 |
| **NEXT_PUBLIC_DEFAULT_APPROVE_AMOUNT** | 前端默认授权额度（最小单位字符串） | 通常为 max uint256 字符串，或与业务约定一致 | `.env`，web 服务 | 可选，有默认 |
| **USDT_ADDRESS** | 链上 USDT 合约地址（后端扣费用） | Base 主网/测试网 USDT 官方合约地址 | Admin 后台「系统设置」（DB settings） | 扣费前必填 |
| **MAX_SINGLE_CHARGE_AMOUNT** | 单笔最大扣费额度（最小单位字符串） | 与 Charger 部署参数一致，如 `"1000000000"` | Admin 后台「系统设置」 | 扣费前必填 |
| **PUBLIC_BASE_URL** | 对外站点根 URL（SIWE domain、前端嵌入链接等） | 生产示例：`https://dapp.sourcofsun.online` | Admin 后台「系统设置」 | SIWE/嵌入前必填 |
| **BASE_RPC_URL**（DB） | 同上，可存一份在 DB 供 API 读 | 同上 | Admin 后台「系统设置」 | 可选 |
| **CONFIRMATIONS_REQUIRED** | 链上确认数（如扣费状态更新） | 数字字符串，如 `"2"` | Admin 后台「系统设置」 | 可选 |

---

## 二、设置位置说明

- **根目录 `.env`**：复制 [.env.example](../.env.example) 为 `.env`，按上表填写。该文件仅存于服务器（或本地部署机），不要提交到 Git。
- **Docker Compose**：`docker-compose.yml` 与 `docker-compose.prod.yml` 通过 `environment` 与 `build.args` 从 `.env` 读取上述变量并传入对应服务；生产部署使用：`docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build`。
- **Admin 后台「系统设置」**：对应 DB 表 `Setting`，通过 Admin 页面或 API `PUT /settings` 写入；用于 CHARGER_CONTRACT_ADDRESS、USDT_ADDRESS、MAX_SINGLE_CHARGE_AMOUNT、PUBLIC_BASE_URL、BASE_RPC_URL、CONFIRMATIONS_REQUIRED 等。

---

## 三、建议配置顺序

1. **部署前**：在 `.env` 中填写 DATABASE_URL、SESSION_SECRET、ADMIN_USER、ADMIN_PASSWORD、COOKIE_SECURE=true、NEXT_PUBLIC_API_URL（生产 API 域名）；若已知合约与链信息，可一并填写 CHARGER_PRIVATE_KEY、CHARGER_CONTRACT_ADDRESS 及 NEXT_PUBLIC_*。
2. **构建并启动**：在服务器项目根目录执行 `docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build`；确认 db 健康后 api/web/admin 正常。
3. **Nginx 与 TLS**：按项目根目录下 `nginx/dapp.sourcofsun.online.conf` 配置反向代理（见该文件内注释），再执行 `certbot --nginx -d dapp.sourcofsun.online -d admin.sourcofsun.online -d api.sourcofsun.online` 申请 HTTPS 证书。
4. **部署后**：登录 Admin，在「系统设置」中填写 CHARGER_CONTRACT_ADDRESS、USDT_ADDRESS、MAX_SINGLE_CHARGE_AMOUNT、PUBLIC_BASE_URL 等；若 Charger 尚未部署，先按 [contracts/](../contracts/) 部署并执行 `setOperator(后端 signer 地址, true)`，再将合约地址填入 `.env` 与 Admin 设置。
5. **前端链上功能**：若需在 Web 端使用授权/扣费，确保 NEXT_PUBLIC_USDT_ADDRESS、NEXT_PUBLIC_CHARGER_CONTRACT_ADDRESS（及可选 NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID）已在构建时通过 `.env` 传入并重新构建 web 服务。

---

## 四、参考

- [VPS部署说明](VPS部署说明.md)：服务器环境、防火墙、应用目录与基本部署流程。
- [工作区迁移总结](工作区迁移总结.md)：环境变量与 DB settings 说明、Charger 部署与 setOperator 要求。
