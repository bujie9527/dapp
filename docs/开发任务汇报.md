# EVM (Base) 最小化 dApp 授权系统 — 开发任务汇报

## 一、任务目标

构建一个 **EVM (Base)** 最小化 dApp 系统，包含：

- **用户端**：单页完成两步授权（SIWE 登录 + USDT approve 给 Charger 合约），并上报事件。
- **管理员后台**：可视化查看授权成功/拒绝/失败日志、用户地址列表、业务配置编辑，并对已 approve 的地址发起扣费（后端用 signer 调用 Charger 合约 `charge`）。

---

## 二、技术栈与仓库结构

| 类别 | 技术选型 |
|------|----------|
| 仓库 | Monorepo（pnpm workspace） |
| 前端 | Next.js (App Router) + TypeScript |
| 钱包 | WalletConnect + wagmi v2 + viem |
| 登录 | SIWE（nonce + verify），Cookie Session |
| 后端 | Express，REST API |
| 数据库 | Postgres + Prisma |
| 合约 | Solidity (Charger.sol)，onlyOwner 调用 charge |
| 部署 | Docker 多阶段构建，docker-compose 编排 |

**目录结构：**

```
├── apps/
│   ├── api/          # 后端 API（Express）
│   ├── admin/       # 管理员后台（Next.js，next start）
│   └── web/         # 用户端（Next.js + wagmi）
├── packages/
│   ├── core/        # 共享类型与 SIWE 工具
│   └── db/          # Prisma schema 与 client
├── contracts/       # Charger.sol + Hardhat
├── docker-compose.yml
├── .dockerignore
└── .env.example
```

---

## 三、交付内容概览

### 1. 数据模型（Prisma）

- **users**：链上地址、创建/更新时间。
- **events**：类型（SIWE / APPROVE / CHARGE）、状态（SUCCESS / REJECTED / FAILED）、地址、txHash、errorSummary、metadata，关联 user/charge。
- **settings**：业务配置 key/value，可审计（updatedBy）。
- **charges**：扣费记录（address、amount、status、txHash、errorSummary），关联 user。

### 2. 合约

- **Charger.sol**：接收 USDT，仅 owner 可调用 `charge(from, amount, ref)` 和 `chargeBatch`；OpenZeppelin Ownable + ReentrancyGuard。

### 3. API 路由（apps/api）

| 路径 | 方法 | 说明 |
|------|------|------|
| /siwe/nonce | GET | 获取 SIWE nonce |
| /siwe/verify | POST | 验证 SIWE 签名，写 session |
| /siwe/me | GET | 当前 session 地址 |
| /auth/login | POST | Admin 登录，校验账号密码，写 session |
| /auth/me | GET | Admin 登录态校验 |
| /auth/logout | POST | Admin 登出 |
| /settings | GET / PUT | 读/写业务配置（PUT 需 Admin） |
| /events | GET / POST | 事件列表（Admin）/ 客户端上报（需 SIWE） |
| /users | GET | 用户列表（Admin） |
| /charge | POST | 发起扣费（Admin，后端 signer 调 Charger） |
| /charge/status | GET | 扣费状态查询（Admin） |

### 4. 用户端（apps/web）

- 单页流程：**连接钱包** → **SIWE 登录** → **授权 USDT (Approve)**，按状态串联。
- 使用 WalletConnect + wagmi v2 + viem，SIWE 后带 Cookie 上报 APPROVE 成功/失败到 POST /events。

### 5. 管理后台（apps/admin）

- **登录**：POST /auth/login，服务端 Session（Cookie），默认账号密码由环境变量 ADMIN_USER / ADMIN_PASSWORD 配置。
- **页面**：事件列表（类型/状态筛选）、用户列表、配置编辑（settings 表）、发起扣费表单、扣费状态页。
- **鉴权**：Dashboard 请求前先 GET /auth/me，401 则跳转登录；API 的 requireAdmin 支持 Session 或 Basic Auth。

### 6. Docker 与编排

- **apps/api**：多阶段构建，启动前执行 `prisma db push` 确保表存在，监听 4000。
- **apps/web**：多阶段构建，standalone 或 next start 可选，监听 3000。
- **apps/admin**：多阶段构建，**采用 next start 启动**（非 standalone），避免 /_next/static 404，监听 3001。
- **docker-compose.yml**：db（Postgres 5432）、api、web、admin；高敏与业务配置通过环境变量注入；反向代理占位已注释，可后续加 nginx/TLS。

---

## 四、安全与配置

- **高敏密钥**（CHARGER_PRIVATE_KEY、DATABASE_URL、SESSION_SECRET）仅通过环境变量/secret 注入，不做后台录入。
- **业务配置**（如 PUBLIC_BASE_URL、BASE_RPC_URL、USDT_ADDRESS、CHARGER_CONTRACT_ADDRESS、DEFAULT_APPROVE_AMOUNT、MAX_SINGLE_CHARGE_AMOUNT、CONFIRMATIONS_REQUIRED）存 DB settings 表，在 admin 后台可视化编辑，可配合审计（updatedBy）。
- **events** 表记录 SIWE / APPROVE / CHARGE，状态区分 SUCCESS / REJECTED / FAILED，保存 errorSummary。
- **Session Cookie**：本地/内网 HTTP 下使用 `COOKIE_SECURE=false`（docker-compose 已配），避免浏览器不发送 Cookie 导致 /auth/me 401。

---

## 五、开发与运行中遇到的问题与修复

| 问题 | 原因 | 处理 |
|------|------|------|
| pnpm 未安装 | 本机未装 Node.js / pnpm | 文档说明从 nodejs.org 安装 Node，再 `npm i -g pnpm` |
| solidity 版本报错 | 误把 npm 包 `solidity` 当编译器 | 从 contracts/package.json 移除，版本由 hardhat.config 指定 |
| Docker BuildKit gRPC 报错 | Windows 下 BuildKit 会话头含非 ASCII | 使用 `$env:DOCKER_BUILDKIT=0` 后再 build |
| node_modules tar 报错 | Windows 下权限/类型导致 unknown file mode | 增加 .dockerignore 排除 node_modules、.pnpm |
| Prisma OpenSSL 警告 | Alpine 未装 OpenSSL | API Dockerfile 中 `apk add openssl` |
| SIWE fromMessage 不存在 | siwe v2 API 变更 | 改为 `new SiweMessage(message)` 解析 |
| Router 类型 TS2742 | 深层 @types 路径不可移植 | 显式标注 `import("express").Router` |
| charge 地址类型 TS2322 | getChargerAddress 返回 string | 返回类型改为 `` `0x${string}` `` |
| Session 类型断言 TS2352 | Session 与 Record 不兼容 | 使用 `(req.session as unknown) as Record<string, unknown>` |
| API runner 无 lockfile | runner 未 COPY pnpm-lock.yaml | 已 COPY，并用 api 的 prisma generate |
| prisma generate 找不到 | runner 中 @dapp/db 无 prisma CLI | 用 `pnpm --filter @dapp/api exec prisma generate --schema=...` |
| Admin 登录后跳回登录页 | 原用 GET /settings 无法校验；localStorage 依赖不可靠 | 改为 POST /auth/login + 服务端 Session（Cookie）；requireAdmin 支持 session |
| Session cookie 不带上 | NODE_ENV=production 时 secure: true | 使用 COOKIE_SECURE 环境变量，docker-compose 设 false |
| /_next/static 404 | standalone 在 monorepo 下路径解析与拷贝不一致 | admin 改为非 standalone，用 next start 启动；static 与 .next 拷贝到正确位置 |
| API /events、/users、/settings 500 | 容器内未建表，Prisma 查表抛错 | 启动 CMD 中先执行 `npx prisma db push`（在 api 目录，用 api 的 prisma）；500 响应带回 e.message 便于排查 |
| Admin runner pnpm 127 | runner 阶段未启用 pnpm | runner 中增加 `corepack enable && corepack prepare pnpm@9.0.0 --activate` |

---

## 六、本地与 Docker 运行方式

**本地开发：**

```bash
pnpm install
cp .env.example .env   # 填写 DATABASE_URL 等
pnpm db:generate
pnpm db:push
pnpm --filter @dapp/api dev
pnpm --filter @dapp/web dev
pnpm --filter @dapp/admin dev
```

- API: http://localhost:4000  
- Web: http://localhost:3000  
- Admin: http://localhost:3001（默认 admin / admin）

**Docker：**

```bash
# Windows 若遇 BuildKit 报错先执行：
$env:DOCKER_BUILDKIT=0

docker compose up --build -d
```

- db: 5432  
- api: 4000（启动前自动 db push）  
- web: 3000  
- admin: 3001（next start，静态资源正常）

---

## 七、总结

本轮开发完成了从仓库结构、数据模型、合约、API、用户端与管理后台到 Docker 编排的完整闭环；用户可在单页完成 SIWE + USDT 授权，管理员可查看日志、用户与配置并发起扣费。过程中通过修正依赖与类型、统一 Admin 鉴权为服务端 Session、调整 Docker 构建与启动方式（含 db 初始化与 admin 静态资源），解决了登录跳回、API 500、静态 404 和 pnpm 缺失等问题，当前可正常使用。
